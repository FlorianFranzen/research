
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Gossiping GRANDPA communication (polite-grandpa) &#8212; Web3 Foundation Research  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/stylesheets/extra.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"extensions": ["tex2jax.js"], "jax": ["input/TeX", "output/HTML-CSS"], "tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "displayMath": [["$$", "$$"], ["\\[", "\\]"]], "processEscapes": true}, "HTML-CSS": {"fonts": ["TeX"]}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Parachain networking" href="3-attestation.html" />
    <link rel="prev" title="Networking for Polkadot" href="1-overview.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p>====================================================================</p>
<p><strong>Authors</strong>: Rob Habermeier, Fatemeh Shirazi </p>
<p><strong>Last updated</strong>: 12.09.2019</p>
<p>====================================================================</p>
<div class="section" id="gossiping-grandpa-communication--polite-grandpa-">
<h1>Gossiping GRANDPA communication (polite-grandpa)<a class="headerlink" href="#gossiping-grandpa-communication--polite-grandpa-" title="Permalink to this headline">¶</a></h1>
<p>This document defines a <em>bounded</em> gossip protocol for circulation of GRANDPA votes.</p>
<p>We have a number of entities:</p>
<ul class="simple">
<li><p>Authorities might be grandpa voters or block producers, but for now we assume they are the same.</p></li>
<li><p>Participants are not voters or block producers and only follow Grandpa’s progress</p></li>
</ul>
<p>Authorities progress in rounds casting votes:</p>
<ul class="simple">
<li><p>For each round a new <em>round topic</em> is created. That is a hash where the preimage includes round number.</p></li>
<li><p>All votes for a round are categorized under the round topic.</p></li>
<li><p>The expected number of messages under honest conditions on a round topic is: N_Authorities * 2 + 1.</p></li>
</ul>
<p>Round message types:
- Prevote (max 2 per voter per round)
- Precommit (max 2 per voter per round)
- Primary-Broadcast (max 2 per round <em>from a single, known, per-round rotating voter</em>).</p>
<p>Although it says max 2 above, honest behavior of voters is to sign and send only one. However, we <em>must</em> import and propagate both votes if we receive more than one. Once we have received 2 of a kind, we can ignore further ones – GRANDPA vote-counting makes further double-votes irrelevant, but accounting for the first double-vote might be necessary to advance consensus.</p>
<p>This is because in GRANDPA equivocations are sometimes needed to complete a round, but a double-equivocation (i.e. triple-voting) is redundant. If an equivocation has occurred, it may lead to supermajority vote-weight on some block which is not possible to achieve through any other combination of issued votes. This means that if we witness an equivocation, we have to make sure our peers also see the equivocation to ensure they see the same result in the round that we do. Otherwise, that can cause a liveness fault. However, f+1 nodes equivocating can cause a safety fault, so this is behavior we want to disincentivize. Our current thinking is that isolated incidents of equivocation would be slashed very little, but the slashing amount would grow very fast with more equivocations happening in a short span of time.</p>
<p>Additionally, there’s a <em>global topic</em> for every voter set. Global topic is for commit messages and catch-up requests. Both these messages are not necessarily related to any specific round, but they are localized to a set of voters. Global topics provide that localization.
- For each completed round of GRANDPA within that voter set, zero or more messages are broadcast on this global topic.
- Messages in the global topic refer to a given round but are not necessary for completion of that round. Rather, messages in the global topic are more relevant to peers who are not interested in the details of how a round has proceeded, but instead are interested in what a particular voter-set has accomplished within its reign.</p>
<p><strong>Global message types</strong>:
- Commit (localized to round. proves finality of a block). Format is <code class="docutils literal notranslate"><span class="pre">(round,</span> <span class="pre">target_number,</span> <span class="pre">target_hash,</span> <span class="pre">Vec&amp;lt;SignedPrecommit&amp;gt;)</span></code> where the precommits prove supermajority of the block with target hash and number.
- Catch-up replies: a collection of messages that allow a peer to be caught up to the point where the sender is <em>within the same voter set</em>. Should only be sent after receiving catch-up request.</p>
<p>Additionally, there are non-gossipped messages that give peers information about their neighbors in the graph.</p>
<p><strong>Neighbor messages:</strong>
  - View Update: <code class="docutils literal notranslate"><span class="pre">(round,</span> <span class="pre">set_id,</span> <span class="pre">commit_height)</span></code>. Sent to all neighbors in the gossip graph periodically to inform of the current view of the protocol.
  - Catch-up request: if a neighbor sends a view that indicates it is at the same voter set, but significantly ahead in round (“significant” is meant to be arbitrary!), the node which is behind will request to be caught-up to the latest state.</p>
<p>A note about catch-ups: in GRANDPA, catch-ups within the same voter set can be done in bounded space. Catching up to the current voter set is done as part of the synchronization process. We special-case commit messages which finalize set-change blocks. These commit messages are kept for all nodes and they are meant to be eagerly sent along with the relevant blocks. If the commit messages are not sent along, the Substrate implementation of GRANDPA contains logic to request peers for them. Assuming they are available, catching up to the latest voter set happens naturally as part of the chain synchronization process. Therefore, the primary downside going offline is that you will need a way to catch up to the most recent round in the current voter set.</p>
<p>https://hackmd.io/BJ-HY2fYTmu-7pRsIWst1w?both contains a run-down of “politeness” of messages.</p>
<p>We can “time-out” messages from voters after receiving double-votes from them (again, only after processing those votes). Messages from timed-out voters can be safely ignored, but the time-out should be limited (10 minutes?) and we must be careful not to have more than <span class="math notranslate nohighlight">\(f = max(n-1, 0)/3\)</span> timed-out at any moment. A FIFO would be good for that.</p>
<p><br/></p>
<div class="section" id="expiration">
<h2>Expiration<a class="headerlink" href="#expiration" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>We can use our local view of the GRANDPA protocol to decide on message expiration.</p></li>
<li>We want to guarantee liveness of all messages for the current and last N (3?) rounds<ul class="simple">
<li><p>Messages in the global topic that refer to these rounds.</p></li>
<li><p>All messages in round topics for the given rounds.</p></li>
<li><p>N=3 is chosen arbitrarily, but is reasonable. there is a way for nodes to catch up even if N=0, but a small N means we fall back on that less.</p></li>
</ul>
</li>
<li><p>Messages only expire based on this (no TTL). In case GRANDPA stalls, e.g. 1/3 of validators go offline, we need these messages to be available until they come back online and the GRANDPA protocol resumes progress.</p></li>
</ul>
</div>
<div class="section" id="validation">
<h2>Validation<a class="headerlink" href="#validation" title="Permalink to this headline">¶</a></h2>
<ul>
<li>Incoming messages for the topics we are subscribed to need to be validated at a higher level.<ul class="simple">
<li><p>Is the message signature valid?</p></li>
<li><p>Is the vote from an authority in the current set? etc.</p></li>
</ul>
</li>
<li><p>We only propagate valid messages and we should assume honest nodes will follow this behavior as well.</p></li>
<li><p>Double votes are <em>valid</em> messages that lead to time-out of the voter (not the sending peer!) <em>after</em> processing.</p></li>
</ul>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Messages in the round topic only need to reach other authorities (includes block producers – same for now)</p></li>
<li><p>Only authorities subscribe to round topics, but we can’t assume full connectivity among authorities, so these messages might need to go through nodes that are not subscribing to the topic.</p></li>
<li><p>We assume that each authrity (voter) is directly connected to at least <span class="math notranslate nohighlight">\(f+1\)</span> other voters, where the total number of voters is <span class="math notranslate nohighlight">\(n=3f+1\)</span>. If the number of conncetion to distinct voters goes down for anyone we should be warned that en eclipse attack is becoming easier.</p></li>
<li><p>Messages in the global topic are only produced by authorities but all full nodes will subscribe to global topics as well.</p></li>
<li><p>Messages in round topics need higher delivery guarantees.</p></li>
<li><p>Messages in the global topic can be missed and don’t need to reach all nodes.</p></li>
<li><p>When a node subscribes to a round topic it should eventually get all messages if the given round topic is within the last N rounds of a majority of nodes (either by fetching them or because the other nodes on the topic rebroadcast them).</p></li>
<li><p>When a node subscribes to a global topic it should eventually get all live messages (i.e. messages for the latest rounds).</p></li>
</ul>
</div>
<div class="section" id="dealing-with-dos">
<h2>Dealing with DoS<a class="headerlink" href="#dealing-with-dos" title="Permalink to this headline">¶</a></h2>
<p>The countermeasure we take to prevent DoS attacks are as follows.</p>
<ul class="simple">
<li><p>We only propagate valid messages, if we receive any invalid message we report the peer with severe misbehavior.</p></li>
<li><p>We only propagate messages that we consider live according to our local view of the GRANDPA protocol. If we receive an expired message from a peer we might (point to discuss!) report it as light misbehavior. Additionally, we might want to send the set of messages we believe would allow GRANDPA to make progress.</p></li>
<li><p>Receiving a duplicate message from the same peer should be reported with light misbehavior (but how do we do repropagation?)</p></li>
<li><p>Future messages from a different set GRANDPA set ID than we are currently on cannot be validated. If we discard these messages, we need to ensure we can get them back later. That probably means communicating to our peers that we aren’t ready for a certain topic yet.</p></li>
<li><p>Future messages from the same set ID can be validated, but pose a DoS risk because they can be arbitrarily far ahead. Again, we can discard these but should make sure we can get them again later. Another approach is to start with a small TTL. The TTL grows based on the number of voters we have seen valid messages (of any kind) for in that round. Once we have seen messages from <span class="math notranslate nohighlight">\(f+1\)</span> voters, the round can be trusted.</p></li>
<li><p>Past (completed) rounds are not a DoS vector. However, we should not accumulate too many in order to avoid gossip spam.</p></li>
<li><p>We should tolerate messages about old rounds from peers – this should not lead to disconnect. However, introducing a periodic “neighbor” message that gets sent to all neighbors (and not propagated further) where we can tell peers our current (set_id, round) makes this less of a problem. If a neighbor gives us a (set_id, round) pair, it would be misbehavior to send them messages about rounds earlier than that.</p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Web3 Foundation Research</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../polkadot.html">Polkadot</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html">Polkadot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Availability_and_Validity.html">Availability and Validity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../GRANDPA.html">GRANDPA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ICMP.html">ICMP Scheme</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Parachain-Allocation.html">Parachain Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Polkadot-Runtime-Environment.html">Polkadot Runtime Environment Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Token Economics.html">Token Economics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BABE.html">BABE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../NPoS.html">NPoS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../keys.html">Keys</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../networking.html">Networking</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1-overview.html">Networking for Polkadot</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Gossiping GRANDPA communication (polite-grandpa)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#expiration">Expiration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#validation">Validation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dealing-with-dos">Dealing with DoS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="3-attestation.html">Parachain networking</a></li>
<li class="toctree-l3"><a class="reference internal" href="4-icmp.html">ICMP</a></li>
<li class="toctree-l3"><a class="reference internal" href="4-icmp.html#interchain-messaging-routing-overview">Interchain Messaging Routing Overview</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../slashing.html">Slashing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../research_team_members.html">Research Team Members</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../../polkadot.html">Polkadot</a><ul>
  <li><a href="../networking.html">Networking</a><ul>
      <li>Previous: <a href="1-overview.html" title="previous chapter">Networking for Polkadot</a></li>
      <li>Next: <a href="3-attestation.html" title="next chapter">Parachain networking</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Web3 Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="../../_sources/polkadot/networking/2-polite-grandpa.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>